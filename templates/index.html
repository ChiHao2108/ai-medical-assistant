<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tr·ª£ l√Ω Y t·∫ø AI (Tham kh·∫£o)</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../static/style.css"> 
</head>
<body>
  <div id="usageWarning" class="warning-banner" style="display: none;">
  ‚ö†Ô∏è B·∫°n ƒë√£ d√πng g·∫ßn h·∫øt s·ªë l∆∞·ª£t mi·ªÖn ph√≠. H√£y c√¢n nh·∫Øc s·ª≠ d·ª•ng ti·∫øt ki·ªám.
  </div>

  <div class="container">
    <div class="background-decoration"></div>

    <h1>üß† Tr·ª£ l√Ω Y t·∫ø AI <br><small>(Th√¥ng tin tham kh·∫£o)</small></h1>

    <div class="disclaimer">
      ‚ö†Ô∏è L∆∞u √Ω: ·ª®ng d·ª•ng n√†y ch·ªâ cung c·∫•p th√¥ng tin tham kh·∫£o. AI kh√¥ng ph·∫£i l√† b√°c sƒ©. Lu√¥n h·ªèi √Ω ki·∫øn chuy√™n gia y t·∫ø ƒë·ªÉ ƒë∆∞·ª£c ch·∫©n ƒëo√°n ch√≠nh x√°c.
    </div>

    <!-- PH√ÇN T√çCH TRI·ªÜU CH·ª®NG -->
    <div class="section">
      <h2>1. Ph√¢n t√≠ch tri·ªáu ch·ª©ng</h2>
      <label for="questionInput">M√¥ t·∫£ tri·ªáu ch·ª©ng c·ªßa b·∫°n:</label>
      <textarea id="questionInput" rows="6" placeholder="V√≠ d·ª•: T√¥i b·ªã s·ªët cao, ho khan, ƒëau h·ªçng..."></textarea>
      <button onclick="askText()">üìù G·ª≠i m√¥ t·∫£</button>
      <div class="result-box">
        <p><strong>K·∫øt qu·∫£ ph√¢n t√≠ch:</strong></p>
        <div id="textResult"></div>
      </div>
    </div>

    <!-- PH√ÇN T√çCH H√åNH ·∫¢NH -->
    <div class="section">
      <h2>2. Ph√¢n t√≠ch h√¨nh ·∫£nh y t·∫ø</h2>
      <label for="imageUpload">Ch·ªçn 1 ho·∫∑c nhi·ªÅu h√¨nh ·∫£nh (v√≠ d·ª•: da, ph√°t ban, v·∫øt th∆∞∆°ng...):</label>
      <input type="file" id="imageUpload" accept="image/*" multiple onchange="previewImages()">
      <div id="imagePreviewContainer" class="image-preview-container"></div>

      <label for="imageTextInput">Th√™m m√¥ t·∫£ v·ªÅ h√¨nh ·∫£nh (t√πy ch·ªçn):</label>
      <input type="text" id="imageTextInput" placeholder="V√≠ d·ª•: M√¥ t·∫£ v·∫øt ban ·ªü tay.">
      <button onclick="analyzeImage()">üß™ Ph√¢n t√≠ch h√¨nh ·∫£nh</button>
      <div class="result-box">
        <p><strong>K·∫øt qu·∫£ ph√¢n t√≠ch:</strong></p>
        <div id="imageResult"></div>
      </div>
    </div>

    <div class="section">
    <h2>B·∫£n ƒë·ªì b·ªánh vi·ªán g·∫ßn b·∫°n</h2>
    <input
      type="text"
      id="mapSearch"
      placeholder="Nh·∫≠p t·ª´ kh√≥a (VD: b·ªánh vi·ªán da li·ªÖu)"
      style="padding: 8px; width: 100%; border-radius: 6px; border: 1px solid #ccc; margin-bottom: 12px;"
    />
    <button onclick="searchMap()" style="padding: 8px 16px; border: none; background: #007bff; color: white; border-radius: 6px;">T√¨m ki·∫øm</button>
    <div id="mapContainer" style="margin-top: 16px;">ƒêang l·∫•y v·ªã tr√≠...</div>
    </div>
  </div>

  <script>
    // Preview nhi·ªÅu ·∫£nh
    function previewImages() {
    const fileInput = document.getElementById('imageUpload');
    const previewContainer = document.getElementById('imagePreviewContainer');
    previewContainer.innerHTML = ''; // Clear c≈©

    const files = fileInput.files;
    if (files.length === 0) return;

    Array.from(files).forEach(file => {
      const reader = new FileReader();
      reader.onload = function(e) {
        const img = document.createElement('img');
        img.src = e.target.result;
        img.className = 'preview-thumb';
        previewContainer.appendChild(img);
      };
      reader.readAsDataURL(file);
    });
  }

    // Ph√¢n t√≠ch vƒÉn b·∫£n
    async function askText() {
      const question = document.getElementById('questionInput').value;
      const textResultDiv = document.getElementById('textResult');
      textResultDiv.innerHTML = '<span class="loading">ƒêang x·ª≠ l√Ω...</span>';
      if (!question) {
        textResultDiv.innerHTML = '‚ö†Ô∏è Vui l√≤ng m√¥ t·∫£ tri·ªáu ch·ª©ng c·ªßa b·∫°n.';
        return;
      }
      try {
        const response = await fetch('/ask_text', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ question: question })
        });
        const data = await response.json();
        textResultDiv.innerText = response.ok ? data.answer : 'L·ªói: ' + data.error;
      } catch (error) {
        textResultDiv.innerText = '‚ùå L·ªói khi g·ª≠i y√™u c·∫ßu: ' + error.message;
      }
    }

    // Ph√¢n t√≠ch nhi·ªÅu ·∫£nh
    async function analyzeImage() {
      const imageFiles = document.getElementById('imageUpload').files;
      const imageTextInput = document.getElementById('imageTextInput').value;
      const imageResultDiv = document.getElementById('imageResult');
      imageResultDiv.innerHTML = '<span class="loading">ƒêang x·ª≠ l√Ω ·∫£nh...</span>';

      if (!imageFiles || imageFiles.length === 0) {
        imageResultDiv.innerHTML = '‚ö†Ô∏è Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 h√¨nh ·∫£nh.';
        return;
      }

      const formData = new FormData();
      for (let i = 0; i < imageFiles.length; i++) {
        formData.append('image', imageFiles[i]);
      }
      formData.append('text_input', imageTextInput);

      try {
        const response = await fetch('/analyze_image', {
          method: 'POST',
          body: formData
        });
        const data = await response.json();
        imageResultDiv.innerText = response.ok ? data.analysis : 'L·ªói: ' + data.error;
      } catch (error) {
        imageResultDiv.innerText = '‚ùå L·ªói khi g·ª≠i y√™u c·∫ßu: ' + error.message;
      }
    }

    let userLat = null;
  let userLon = null;

  window.onload = function () {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(success, error);
    } else {
      document.getElementById('mapContainer').innerHTML = "Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã.";
    }
  };

  fetch('/usage_check')
  .then(res => res.json())
  .then(data => {
    if (data.warning) {
      document.getElementById("usageWarning").style.display = "block";
    }
  })
  .catch(err => console.log("L·ªói khi l·∫•y l∆∞·ª£t:", err));


  function success(position) {
    userLat = position.coords.latitude;
    userLon = position.coords.longitude;
    showMap("b·ªánh vi·ªán"); // hi·ªÉn th·ªã m·∫∑c ƒë·ªãnh l√† "b·ªánh vi·ªán"
  }

  function error() {
    document.getElementById('mapContainer').innerHTML = "Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠.";
  }

  function showMap(query) {
  const mapUrl = `https://www.google.com/maps?q=${query}+g·∫ßn+${userLat},${userLon}`;
  const iframe = `
    <div style="text-align: right; margin-top: 10px;">
      <a
        href="${mapUrl}"
        target="_blank"
        style="
          display: inline-block;
          background: linear-gradient(to right, #28c2f4, #2b9ed2);
          color: white;
          font-weight: 600;
          padding: 10px 18px;
          border-radius: 8px;
          text-decoration: none;
          box-shadow: 0 4px 12px rgba(40,194,244,0.3);
          transition: transform 0.2s ease, box-shadow 0.2s ease;
        "
        onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 6px 18px rgba(40,194,244,0.4)'"
        onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 12px rgba(40,194,244,0.3)'"
      >
        üìç Xem b·∫£n ƒë·ªì l·ªõn h∆°n
      </a>
    </div>

    <br>
    
    <iframe
      width="100%"
      height="450"
      style="border:0; border-radius: 12px;"
      loading="lazy"
      allowfullscreen
      referrerpolicy="no-referrer-when-downgrade"
      src="${mapUrl}&hl=vi&z=15&output=embed">
    </iframe>
  `;
  document.getElementById('mapContainer').innerHTML = iframe;
}


  function searchMap() {
    const query = document.getElementById('mapSearch').value;
    if (!query.trim()) {
      alert("Vui l√≤ng nh·∫≠p t·ª´ kh√≥a t√¨m ki·∫øm (v√≠ d·ª•: b·ªánh vi·ªán da li·ªÖu)");
      return;
    }
    showMap(query);
  }
  </script>
</body>
</html>
